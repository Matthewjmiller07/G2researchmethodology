<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G2 Retro Trainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* Apply Press Start 2P font & Retro Styles */
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a2e; /* Dark blue background */
            color: #e0e0e0; /* Light gray text */
            overscroll-behavior: none; /* Prevent bounce */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        /* Game container styling - Retro Border */
        .game-container {
            border: 4px solid #4a4a8a; /* Purple border */
            background-color: #162447; /* Slightly lighter blue */
            box-shadow: 0 0 15px rgba(74, 74, 138, 0.7);
            image-rendering: pixelated; /* Keep things crisp */
            width: 100%;
            max-width: 800px;
            position: relative;
            overflow: hidden; /* Hide potential overflows */
            border-radius: 0; /* Sharp corners */
        }

        /* Text styling */
        h1, h2, h3, label, button, select, p, div, a, li { /* Added li */
            font-family: 'Press Start 2P', cursive;
             line-height: 1.5; /* Better readability for pixel font */
        }
        h1 { color: #00bcd4; } /* Cyan */
        h2 { color: #bd93f9; } /* Purple */
        h3 { color: #f1fa8c; } /* Yellow */
        label { color: #50fa7b; } /* Green */


        /* Button styling - Retro */
        .btn {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            background-color: #e43f5a; /* Red button - Default */
            color: #ffffff;
            text-shadow: 1px 1px #000000;
            box-shadow: 3px 3px 0px #1f4068; /* Blue shadow */
            cursor: pointer;
            transition: all 0.1s ease;
            display: inline-block;
            text-align: center;
            line-height: 1.2;
            margin-top: 5px; /* Add some spacing */
             margin-bottom: 5px;
        }
        .btn:disabled {
             background-color: #555; color: #999; cursor: not-allowed; box-shadow: 3px 3px 0px #333;
             transform: none !important;
        }
        .btn:active:not(:disabled) {
            transform: translate(2px, 2px); box-shadow: 1px 1px 0px #1f4068;
        }
         /* Primary Button (Next Question) - Cyan */
        .btn-primary {
            background-color: #00bcd4; color: #1a1a2e; text-shadow: 1px 1px #e0e0e0; box-shadow: 3px 3px 0px #008ba3;
        }
        .btn-primary:active:not(:disabled) { box-shadow: 1px 1px 0px #008ba3; }
         /* Alt Button (Try Again) - Orange */
        .btn-alt {
             background-color: #ffb86c; color: #1a1a2e; text-shadow: 1px 1px #f8f8f2; box-shadow: 3px 3px 0px #8b4513;
        }
        .btn-alt:active:not(:disabled) { box-shadow: 1px 1px 0px #8b4513; }
         /* Launch/Example Button (Show Example) - Green */
        .btn-launch {
             background-color: #50fa7b; color: #1a1a2e; text-shadow: 1px 1px #f8f8f2; box-shadow: 3px 3px 0px #2aaa57;
        }
        .btn-launch:active:not(:disabled) { box-shadow: 1px 1px 0px #2aaa57; }
         /* Secondary Button (Modal Close) - Dark */
        .btn-secondary {
             background-color: #1b1b2f; box-shadow: 3px 3px 0px #4a4a8a;
        }
         .btn-secondary:active:not(:disabled) { box-shadow: 1px 1px 0px #4a4a8a; }


        /* Input/Textarea/Select styling - Retro */
        textarea, select {
            font-family: 'Press Start 2P', cursive;
            background-color: #1f4068; border: 2px solid #4a4a8a; color: #f5f5f5;
            padding: 10px; outline: none; resize: none; width: 100%;
             border-radius: 0; /* Sharp corners */
        }
         textarea:disabled { background-color: #333; color: #777; cursor: not-allowed; }
         textarea::placeholder { color: #a0a0c0; }
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat; background-position: right 10px center; background-size: 18px; padding-right: 35px;
        }
        option.completed-level { color: #50fa7b !important; font-weight: bold; } /* Keep green check */


        /* Feedback styling - Retro Colors */
        .feedback-area {
            border: 2px dashed #4a4a8a; background-color: rgba(0, 0, 0, 0.2); padding: 1rem;
            display: flex; flex-direction: column; justify-content: space-between;
             border-radius: 0;
        }
        .feedback-item { margin-bottom: 5px; padding: 3px 5px; border-radius: 0; transition: background-color 0.2s ease, transform 0.2s ease; border-left-width: 3px; border-left-style: solid; font-size: 0.7rem; } /* Adjusted font size */
        .feedback-good { color: #50fa7b; background-color: rgba(80, 250, 123, 0.1); border-left-color: #50fa7b; } /* Green */
        .feedback-improve { color: #f1fa8c; background-color: rgba(241, 250, 140, 0.1); border-left-color: #f1fa8c; } /* Yellow */
        .feedback-critical { color: #ff5555; background-color: rgba(255, 85, 85, 0.1); border-left-color: #ff5555; } /* Red */
        .feedback-bonus { color: #bd93f9; background-color: rgba(189, 147, 249, 0.1); border-left-color: #bd93f9; font-weight: bold; } /* Purple */
        .feedback-highlight { background-color: rgba(255, 255, 100, 0.3) !important; transform: scale(1.02); }


        /* Animations - Retro Flash */
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .flash-success { animation: flash 0.5s 2; color: #50fa7b; }
        .flash-fail { animation: flash 0.5s 2; color: #ff5555; }
        .flash-perfect { animation: flash 0.6s 3; color: #bd93f9; }

        /* Icon Animation */
        @keyframes iconPop { 0% { transform: scale(0.8) rotate(-15deg); opacity: 0; } 70% { transform: scale(1.1) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        #winIcon { font-size: 2rem; display: inline-block; }
        .animate-icon { animation: iconPop 0.8s ease-out forwards; }


        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Score animation style */
        .score-animating { color: #f1fa8c; transform: scale(1.1); transition: color 0.1s ease-out, transform 0.1s ease-out; }

        /* Consistent minimum height for content screens */
        .content-screen { min-height: 450px; /* Adjusted slightly */ }

        /* Modal Styles - Retro */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: #162447; border: 4px solid #bd93f9; padding: 1.5rem; text-align: center; max-width: 90%; width: 550px; position: relative; box-shadow: 0 0 20px rgba(189, 147, 249, 0.5); border-radius: 0; }
        .modal-close-btn { position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 1.5rem; color: #ff5555; cursor: pointer; font-family: 'Press Start 2P', cursive; padding: 0; line-height: 1; }
        #modalAnswerDisplay { background-color: #1f4068; border: 1px solid #4a4a8a; color: #f5f5f5; padding: 10px; width: 100%; height: 150px; overflow-y: auto; margin-top: 1rem; margin-bottom: 1.5rem; text-align: left; font-size: 0.7rem; white-space: pre-wrap; border-radius: 0;}

        /* Multiple Choice Styles */
        #multipleChoiceOptions {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between options */
        }
        .choice-btn {
            /* Inherit .btn styles but customize */
            background-color: #4a4a8a; /* Purple base */
            color: #e0e0e0;
            text-align: left; /* Align text left */
            width: 100%;
            box-shadow: 3px 3px 0px #1b1b2f; /* Darker shadow */
            font-size: 0.75rem; /* Match text size */
            padding: 8px 12px; /* Adjust padding */
        }
         .choice-btn.selected {
             background-color: #f1fa8c; /* Yellow selected */
             color: #1a1a2e;
             box-shadow: 3px 3px 0px #8b4513; /* Orange shadow */
             border-color: #f1fa8c;
         }
         .choice-btn:active:not(:disabled) {
             box-shadow: 1px 1px 0px #1b1b2f;
             transform: translate(2px, 2px); /* Keep retro active effect */
         }
         .choice-btn.selected:active:not(:disabled) {
             box-shadow: 1px 1px 0px #8b4513;
             transform: translate(2px, 2px);
         }
    </style>
</head>
<body>
    <div class="game-container p-4 sm:p-6 text-xs sm:text-sm">
        <div class="flex justify-between items-center mb-4 border-b-2 border-dashed border-cyan-400 pb-2">
            <h1 class="text-lg sm:text-xl">G2 Retro Trainer</h1>
            <div class="text-right">
                <div class="text-green-400">SCORE: <span id="score" class="transition-all duration-100">0</span></div>
                <div class="text-yellow-400">LIVES: <span id="lives">5</span></div>
            </div>
        </div>

        <div id="levelSelectionArea" class="mb-4">
            <label for="levelSelect" class="block mb-1 text-fuchsia-400">Select Module:</label>
            <select id="levelSelect" class="w-full"></select>
        </div>

        <div id="challengeScreen" class="content-screen mb-4 p-3 border-2 border-cyan-400 bg-black bg-opacity-20">
             <h2 class="text-base sm:text-lg text-fuchsia-400 mb-2">Incoming Question!</h2>
            <p class="text-green-400 mb-1">SITUATION:</p>
            <p id="scenarioText" class="mb-3 h-16 overflow-y-auto no-scrollbar">Select a module to start...</p>
             <div id="weakPromptSection">
                <p class="text-red-400 mb-1">INCORRECT IDEA:</p>
                <p id="weakPromptText" class="text-yellow-400 mb-3 h-12 overflow-y-auto no-scrollbar"></p>
            </div>

            <div id="explanationInputArea">
                <label for="userPrompt" class="block mb-1 text-cyan-400">Enter Correct Explanation:</label>
                <textarea id="userPrompt" rows="4" class="w-full mb-3" placeholder="Explain the G2 concept..."></textarea>
            </div>

             <div id="multipleChoiceArea" class="hidden">
                 <label id="mcqLabel" class="block mb-1 text-cyan-400">Select the Correct Answer:</label>
                 <div id="multipleChoiceOptions">
                     </div>
             </div>

            <button id="submitBtn" class="btn w-full mt-4" disabled>Submit Analysis!</button>
        </div>

        <div id="resultsScreen" class="content-screen feedback-area hidden">
             <div>
                 <h3 id="resultTitle" class="text-base text-center mb-3">Analyzing...</h3>
                 <div id="feedbackOutput" class="text-xs max-h-48 overflow-y-auto no-scrollbar mb-4"></div>
             </div>
             <div class="text-center mt-auto pt-3">
                  <button id="showExampleBtn" class="btn btn-launch hidden mb-2">Show Example Answer</button>
                  <div class="flex justify-center space-x-4">
                      <button id="tryAgainBtn" class="btn btn-alt">Try Again</button>
                      <button id="nextChallengeBtn" class="btn btn-primary">Next Question</button>
                  </div>
             </div>
        </div>

         <div id="gameOverScreen" class="text-center p-6 hidden">
             <h2 class="text-2xl text-red-500 mb-4">TRAINING FAILED!</h2>
             <p class="text-lg mb-4">Final Score: <span id="finalScore" class="text-yellow-400">0</span></p>
             <button id="restartBtn" class="btn">Restart Training</button>
         </div>

         <div id="winScreen" class="text-center p-6 hidden">
             <h2 class="text-2xl text-green-400 mb-2">MODULE COMPLETE!</h2>
             <p class="text-lg mb-4 text-cyan-400">Module Cleared: <span id="clearedZoneName"></span></p>
              <div class="my-6 h-16 relative flex justify-center items-end"> <span id="winIcon" class="">📊</span> </div>
             <button id="playAgainBtn" class="btn">Play Again (Reset)</button>
             </div>

        <p class="text-xs text-center text-gray-500 mt-4">
            Based on G2 Research Methodology.
        </p>
    </div>

    <div id="exampleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn">X</button>
            <h3 class="text-lg text-fuchsia-400 mb-3">Example Answer</h3>
            <p class="text-xs mb-4 leading-relaxed">
                Example explanation based on G2 methodology:
            </p>
            <div id="modalAnswerDisplay" class="no-scrollbar"></div>
            <div class="flex justify-center space-x-4 mt-4">
                 <button id="closeModalBtnInner" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>


    <script>
        // --- G2 Methodology Feedback Points (Explanation Type Only) ---
        const g2FeedbackPoints = {
            corePrinciples: { authenticity: "Mention authentic user feedback?", transparency: "Reference transparent methods?", objectivity: "Highlight objective data?", buyerFocus: "Mention buyer focus?" },
            categorization: { b2b: "Specify B2B product/service?", functionality: "Categorization by functionality?", hierarchy: "Describe category hierarchy?" },
            scoringComponents: { satisfaction: "Identify Satisfaction Score?", marketPresence: "Identify Market Presence Score?", bothComponents: "Mention BOTH components?" },
            satisfactionFactors: { userAttributes: "Include end-user attributes?", reviewQuality: "Mention review quality/completeness?", reviewAge: "Reference review age/recency?", nps: "Include NPS/overall satisfaction?" },
            marketPresenceFactors: { g2Reviews: "Include G2 review metrics?", thirdParty: "Mention 3rd party/social data?", companySize: "Reference vendor size/growth?", webPresence: "Include web/social presence?" },
            gridReport: { axes: "Identify Grid axes (Sat/MP)?", quadrants: "Name Grid quadrants?", interpretation: "Explain quadrant meaning?", eligibility: "Mention Grid eligibility (reviews)?" },
            indexReport: { purpose: "Explain Index Report purpose?", example: "Name an Index Report type?", basis: "Mention specific review questions?" },
            momentumGrid: { purpose: "Explain Momentum Grid purpose (growth)?", factors: "Name Momentum factors?" }
        };

        // --- Game Data (G2 Themed - WITH Game Types) ---
        const gameData = {
             "Core Principles & Categorization": [
                 {
                    type: 'explanation', // <<< Game Type
                    scenario: "A new colleague asks what makes G2 Research different from traditional analyst firms.",
                    weakPrompt: "G2 is just based on reviews.",
                    examplePrompt: "G2 Research relies on authentic, verified user reviews[cite: 6], not subjective analyst opinions. It uses transparent methodologies [cite: 6] and objective data [cite: 6] to provide a buyer-centric perspective[cite: 6], helping users make informed decisions.",
                    feedbackPoints: g2FeedbackPoints.corePrinciples,
                    keywords: { authenticity: /authentic|user review|real users/i, transparency: /transparent|clear/i, objectivity: /objective|quantifiable|data/i, buyerFocus: /buyer|decision/i }
                 },
                 {
                     type: 'multipleChoice', // <<< Game Type
                     scenario: "Which type of product is generally NOT listed on G2?",
                     weakPrompt: "", // Not used for MCQ
                     options: [
                         "B2B SaaS Platform",
                         "Consumer Mobile Game", // Correct Answer
                         "Open Source B2B Tool",
                         "On-premise Enterprise Software"
                     ],
                     answer: "Consumer Mobile Game",
                     feedbackPoints: { correct: "Correct! G2 focuses on B2B software and services[cite: 7]." , incorrect: "Incorrect. G2 primarily lists B2B software and services[cite: 7]." } // Simplified feedback
                 },
                 {
                    type: 'explanation',
                    scenario: "Explain how G2 organizes its software categories.",
                    weakPrompt: "They just list software types.",
                    examplePrompt: "G2 uses a category hierarchy: High-level parent categories (e.g., Sales Software), Mid-level categories (e.g., Quote Management), and specific Child categories (e.g., Pricing Software)[cite: 10].",
                    feedbackPoints: g2FeedbackPoints.categorization,
                    keywords: { b2b: /b2b/i, functionality: /functionality|features/i, hierarchy: /hierarchy|category|parent|child|level/i }
                 },
                 {
                     type: 'multipleChoice',
                     scenario: "How are software products primarily categorized on G2?",
                     weakPrompt: "",
                     options: [
                         "By vendor size",
                         "By target industry",
                         "Based on functionality/features", // Correct
                         "By pricing model"
                     ],
                     answer: "Based on functionality/features",
                     feedbackPoints: { correct: "Correct! Products are categorized based on functionality (features), not use case[cite: 7].", incorrect: "Incorrect. G2 categorizes based on functionality and features[cite: 7]." }
                 },
                 {
                     type: 'explanation',
                     scenario: "What's the difference between a Standard Product and a Product Suite on G2?",
                     weakPrompt: "They are basically the same.",
                     examplePrompt: "A Standard Product is individual software[cite: 9]. A Product Suite combines multiple products from one vendor, offering expanded features[cite: 9]. Suites are scored aggregating across categories[cite: 15].",
                     feedbackPoints: g2FeedbackPoints.categorization, // Reusing
                     keywords: { b2b:/product type/i, functionality: /standard product|individual|suite|combination|aggregate/i, hierarchy:/suite|standard/i }
                 }
            ],
            "Scoring Factors": [
                 {
                    type: 'explanation',
                    scenario: "How is the overall G2 Score for a software product calculated?",
                    weakPrompt: "It's based on how many reviews they have.",
                    examplePrompt: "A product's G2 Score uses two main components: the Satisfaction score and the Market Presence score[cite: 11].",
                    feedbackPoints: g2FeedbackPoints.scoringComponents,
                    keywords: { satisfaction: /satisfaction/i, marketPresence: /market presence/i, bothComponents: /satisfaction.*market presence|market presence.*satisfaction|two components|both/i }
                 },
                  {
                     type: 'multipleChoice',
                     scenario: "Which of these is a major factor in the G2 *Satisfaction* Score?",
                     weakPrompt: "",
                     options: [
                         "Vendor's annual revenue",
                         "Number of employees at the vendor company",
                         "Age and Quality of Reviews", // Correct
                         "Vendor's website traffic"
                     ],
                     answer: "Age and Quality of Reviews",
                     feedbackPoints: { correct: "Correct! Review age, quality, user satisfaction attributes, and NPS impact Satisfaction[cite: 12].", incorrect: "Incorrect. Satisfaction is driven by factors like review age/quality, user satisfaction, and NPS[cite: 12]." }
                 },
                 {
                    type: 'explanation',
                    scenario: "What contributes to a product's Market Presence score on G2?",
                    weakPrompt: "It's just how big the company is.",
                    examplePrompt: "Market Presence includes G2 review metrics, third-party/social data, employee count/growth, web presence/social influence, and product age[cite: 12].",
                    feedbackPoints: g2FeedbackPoints.marketPresenceFactors,
                    keywords: { g2Reviews: /g2 reviews|review metrics/i, thirdParty: /third party|external sources|social network/i, companySize: /employee|company size|growth/i, webPresence: /web presence|social influence|website/i }
                 },
                 {
                     type: 'multipleChoice',
                     scenario: "How does G2 treat older reviews compared to newer ones?",
                     weakPrompt: "",
                     options: [
                         "Older reviews are weighted more heavily",
                         "All reviews have equal weight",
                         "Reviews lose value as they age", // Correct
                         "Only reviews from the last 6 months count"
                     ],
                     answer: "Reviews lose value as they age",
                     feedbackPoints: { correct: "Correct! Reviews lose value as they age (approx -30% per year)[cite: 21].", incorrect: "Incorrect. Reviews lose value over time as newer reviews are more relevant[cite: 21]." }
                 }
                 // Add more scoring factor questions (explanation or MCQ)
            ],
            "Market Reports": [
                 {
                    type: 'explanation',
                    scenario: "Explain the main purpose and axes of the G2 Grid® Report.",
                    weakPrompt: "It's a graph showing popular software.",
                    examplePrompt: "The G2 Grid® plots products by Satisfaction score (y-axis) and Market Presence score (x-axis) [cite: 16] to show the competitive landscape.",
                    feedbackPoints: g2FeedbackPoints.gridReport,
                    keywords: { axes: /axis|axes|satisfaction.*market presence|market presence.*satisfaction/i, quadrants: /leader|high performer|contender|niche|quadrant/i, interpretation: /landscape|compare|position/i, eligibility: /reviews|eligible|minimum/i }
                 },
                 {
                     type: 'multipleChoice',
                     scenario: "On the G2 Grid, which quadrant represents High Satisfaction but Lower Market Presence?",
                     weakPrompt: "",
                     options: [
                         "Leaders",
                         "Contenders",
                         "Niche",
                         "High Performers" // Correct
                     ],
                     answer: "High Performers",
                     feedbackPoints: { correct: "Correct! High Performers have high Satisfaction but lower Market Presence scores[cite: 17].", incorrect: "Incorrect. High Performers are in the top left quadrant (High Satisfaction, Lower Market Presence)[cite: 17]." }
                 },
                 {
                    type: 'explanation',
                    scenario: "What's the difference between a Grid Report and an Index Report?",
                    weakPrompt: "They are just different ways to show scores.",
                    examplePrompt: "Grid Reports plot overall Satisfaction vs. Market Presence[cite: 16]. Index Reports (e.g., Usability, Relationship) focus on specific areas using specific review questions[cite: 19].",
                    feedbackPoints: g2FeedbackPoints.indexReport,
                    keywords: { purpose: /index|specific area|usability|implementation|relationship|results/i, example: /usability|implementation|relationship|results|index type/i, basis: /specific questions|subset of questions/i }
                 },
                 {
                     type: 'multipleChoice',
                     scenario: "Which G2 report specifically measures a product's growth trajectory?",
                     weakPrompt: "",
                     options: [
                         "Usability Index Report",
                         "Momentum Grid® Report", // Correct
                         "Relationship Index Report",
                         "Standard Grid® Report"
                     ],
                     answer: "Momentum Grid® Report",
                     feedbackPoints: { correct: "Correct! The Momentum Grid® measures growth trajectory based on factors like review and web growth[cite: 20, 25].", incorrect: "Incorrect. The Momentum Grid® focuses on growth trajectory[cite: 20, 25]." }
                 }
                 // Add more report questions (explanation or MCQ)
            ]
        };

        // --- DOM Elements ---
        const levelSelect = document.getElementById('levelSelect');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const challengeScreen = document.getElementById('challengeScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winScreen = document.getElementById('winScreen');
        const levelSelectionArea = document.getElementById('levelSelectionArea');
        const scenarioText = document.getElementById('scenarioText');
        const weakPromptSection = document.getElementById('weakPromptSection'); // Div containing weak prompt
        const weakPromptText = document.getElementById('weakPromptText');
        // Input Areas
        const explanationInputArea = document.getElementById('explanationInputArea');
        const userPrompt = document.getElementById('userPrompt'); // Textarea
        const multipleChoiceArea = document.getElementById('multipleChoiceArea');
        const mcqLabel = document.getElementById('mcqLabel'); // Label for MCQ
        const multipleChoiceOptions = document.getElementById('multipleChoiceOptions'); // Div for buttons
        // Buttons
        const submitBtn = document.getElementById('submitBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const nextChallengeBtn = document.getElementById('nextChallengeBtn');
        const restartBtn = document.getElementById('restartBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const showExampleBtn = document.getElementById('showExampleBtn');
        // Displays
        const resultTitle = document.getElementById('resultTitle');
        const feedbackOutput = document.getElementById('feedbackOutput');
        const finalScoreDisplay = document.getElementById('finalScore');
        const winIcon = document.getElementById('winIcon');
        const clearedZoneName = document.getElementById('clearedZoneName');
        // Modal Elements
        const exampleModal = document.getElementById('exampleModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtnInner = document.getElementById('closeModalBtnInner');
        const modalAnswerDisplay = document.getElementById('modalAnswerDisplay');

        // --- Game State ---
        let score = 0;
        let lives = 5;
        let currentLevel = '';
        let currentChallengeIndex = -1;
        let currentChallengeData = null;
        let completedChallengesByLevel = {};
        let completedLevels = [];
        let scoreAnimationInterval = null;
        let isEvaluating = false;
        let lastExampleAnswer = "";
        let lastChallengeSuccess = false;
        let selectedMultipleChoiceButton = null; // Store the selected MCQ option button

        // --- Sound Effects (Tone.js - Retro sounds) ---
         const synth = new Tone.Synth().toDestination();
         const polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
         const noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination();
         noiseSynth.volume.value = -20;
         const bonusSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.1, decay: 0, sustain: 1, release: 0.5 } }).toDestination();
         bonusSynth.volume.value = -10;
         const tryAgainSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
         tryAgainSynth.volume.value = -15;
         const modalSynth = new Tone.Synth({ oscillator: { type: "pwm", modulationFrequency: 0.2 }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.2, release: 0.3 } }).toDestination();
         modalSynth.volume.value = -12;
         const winSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 1 } }).toDestination();
         winSynth.volume.value = -8;

         function playSound(type) {
             if (Tone.context.state !== 'running') {
                 Tone.start().then(() => _playSoundInternal(type)).catch(e => console.error("Error starting Tone:", e));
             } else {
                 _playSoundInternal(type);
             }
         }

         function _playSoundInternal(type) {
             const now = Tone.now();
             try {
                 if (type === 'submit') synth.triggerAttackRelease("C4", "8n", now);
                 else if (type === 'success') polySynth.triggerAttackRelease(["C4", "G4", "C5"], "8n", now);
                 else if (type === 'fail') synth.triggerAttackRelease("A2", "4n", now);
                 else if (type === 'gameOver') polySynth.triggerAttackRelease(["C3", "E2", "G2"], "2n", now);
                 else if (type === 'next') { synth.triggerAttackRelease("E4", "16n", now); synth.triggerAttackRelease("G4", "16n", now + 0.1); }
                 else if (type === 'tick') noiseSynth.triggerAttackRelease(now);
                 else if (type === 'bonus') { bonusSynth.triggerAttackRelease("C5", "4n", now); bonusSynth.triggerAttackRelease("G5", "4n", now + 0.2); bonusSynth.triggerAttackRelease("C6", "2n", now + 0.4); }
                 else if (type === 'tryAgain') { tryAgainSynth.triggerAttackRelease("E3", "8n", now); tryAgainSynth.triggerAttackRelease("G3", "8n", now + 0.1); }
                 else if (type === 'modalOpen') modalSynth.triggerAttackRelease("C4", "4n", now);
                 else if (type === 'modalClose') modalSynth.triggerAttackRelease("G3", "4n", now);
                 else if (type === 'win') { winSynth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1n", now); winSynth.triggerAttackRelease(["G4", "B4", "D5", "G5"], "1n", now + 0.5); }
             } catch (error) { console.error("Tone.js error:", error); }
         }

        // --- Functions ---

        function showScreen(screenToShow) {
            if (scoreAnimationInterval) { clearInterval(scoreAnimationInterval); scoreAnimationInterval = null; scoreDisplay.classList.remove('score-animating'); }
            challengeScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            winScreen.classList.add('hidden');
            exampleModal.classList.add('hidden'); // Hide modal too
            // Show level select unless game over
            levelSelectionArea.classList.toggle('hidden', screenToShow === 'gameOver');

            if (screenToShow === 'challenge') challengeScreen.classList.remove('hidden');
            else if (screenToShow === 'results') resultsScreen.classList.remove('hidden');
            else if (screenToShow === 'gameOver') gameOverScreen.classList.remove('hidden');
            else if (screenToShow === 'win') {
                 winScreen.classList.remove('hidden');
                 winIcon.classList.remove('animate-icon');
                 void winIcon.offsetWidth; // Reflow trick
                 winIcon.classList.add('animate-icon');
            }
        }

        function animateScore(pointsToAdd) {
             return new Promise(resolve => {
                 const startDisplayScore = parseInt(scoreDisplay.textContent) || 0;
                 const targetDisplayScore = startDisplayScore + pointsToAdd;
                  // Exit early if no points or negative points (no animation needed)
                 if (pointsToAdd <= 0) {
                    score = targetDisplayScore; // Update score state directly
                    updateDisplays(); // Update the display
                    resolve();
                    return;
                 }

                 let currentDisplayScore = startDisplayScore;
                 const incrementAmount = Math.max(1, Math.min(7, Math.ceil(pointsToAdd / 15))); // Keep scoring speed reasonable
                 const intervalTime = 60;

                 if (scoreAnimationInterval) clearInterval(scoreAnimationInterval);
                 scoreDisplay.classList.add('score-animating');

                 scoreAnimationInterval = setInterval(() => {
                     currentDisplayScore += incrementAmount;
                     if (currentDisplayScore >= targetDisplayScore) {
                         currentDisplayScore = targetDisplayScore;
                         clearInterval(scoreAnimationInterval);
                         scoreAnimationInterval = null;
                         scoreDisplay.classList.remove('score-animating');
                         score = currentDisplayScore; // Update actual score state
                         scoreDisplay.textContent = currentDisplayScore;
                         resolve();
                     } else {
                          scoreDisplay.textContent = currentDisplayScore;
                          playSound('tick');
                     }
                 }, intervalTime);
                 playSound('tick'); // Initial tick
             });
         }

        function initializeGame() {
            console.log("Initializing G2 Retro Trainer...");
            score = 0;
            lives = 5;
            currentLevel = '';
            currentChallengeIndex = -1;
            lastExampleAnswer = "";
            completedChallengesByLevel = {};
            completedLevels = [];
            isEvaluating = false;
            selectedMultipleChoiceButton = null;
            if (scoreAnimationInterval) clearInterval(scoreAnimationInterval);
            scoreAnimationInterval = null;

            updateDisplays();
            populateLevels();
            showScreen('challenge'); // Start on challenge screen
            submitBtn.disabled = true;
            userPrompt.disabled = false;
            showExampleBtn.classList.add('hidden');
            exampleModal.classList.add('hidden');

            if (levelSelect.options.length > 0) {
                 levelSelect.value = levelSelect.options[0].value;
                 changeLevel();
             } else {
                scenarioText.textContent = 'No modules available!';
                weakPromptText.textContent = '';
                submitBtn.disabled = true;
            }
            console.log("Initialization complete.");
        }

        function populateLevels() {
            const currentSelectedValue = levelSelect.value;
            levelSelect.innerHTML = '';
            const levels = Object.keys(gameData);
            levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                let levelText = level;
                if (completedLevels.includes(level)) {
                    option.textContent = `✅ ${levelText}`;
                    option.classList.add('completed-level');
                } else {
                     option.textContent = levelText;
                     option.classList.remove('completed-level');
                }
                levelSelect.appendChild(option);
            });
             if (levels.includes(currentSelectedValue)) {
                 levelSelect.value = currentSelectedValue;
             } else if (levels.length > 0) {
                  levelSelect.value = levels[0];
             }
        }

         function changeLevel() {
             currentLevel = levelSelect.value;
             if (!currentLevel) return;
             if (!completedChallengesByLevel[currentLevel]) {
                 completedChallengesByLevel[currentLevel] = [];
             }
             currentChallengeIndex = -1;
             loadChallenge();
         }

        function loadChallenge() {
             if (isEvaluating) return;
             showExampleBtn.classList.add('hidden');
             selectedMultipleChoiceButton = null; // Reset MCQ selection

             if (!currentLevel || !gameData[currentLevel] || gameData[currentLevel].length === 0) {
                 scenarioText.textContent = 'No questions in this module!';
                 weakPromptText.textContent = ''; currentChallengeData = null; submitBtn.disabled = true; showScreen('challenge'); return;
             }

             const levelChallenges = gameData[currentLevel];
             const totalChallengesInLevel = levelChallenges.length;
             if (!completedChallengesByLevel[currentLevel]) completedChallengesByLevel[currentLevel] = [];
             const completedIndices = completedChallengesByLevel[currentLevel];
             const availableIndices = levelChallenges.map((_, i) => i).filter(i => !completedIndices.includes(i));

             if (availableIndices.length === 0) {
                 if (totalChallengesInLevel > 0 && !completedLevels.includes(currentLevel)) { winGame(); }
                 else { scenarioText.textContent = 'Module complete or empty!'; weakPromptText.textContent = ''; submitBtn.disabled = true; }
                 return;
             }

             currentChallengeIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
             currentChallengeData = levelChallenges[currentChallengeIndex];

             if (!currentChallengeData) { console.error("Err loading challenge:", currentChallengeIndex, currentLevel); isEvaluating = false; loadChallenge(); return; }

             // --- Configure UI based on challenge type ---
             scenarioText.textContent = currentChallengeData.scenario;
             userPrompt.value = ''; // Clear textarea
             userPrompt.disabled = false; // Enable textarea by default
             multipleChoiceOptions.innerHTML = ''; // Clear old MCQ options
             submitBtn.disabled = true; // Disable submit initially

             if (currentChallengeData.type === 'multipleChoice') {
                explanationInputArea.classList.add('hidden'); // Hide textarea
                multipleChoiceArea.classList.remove('hidden'); // Show MCQ area
                weakPromptSection.classList.add('hidden'); // Hide weak prompt for MCQ
                mcqLabel.textContent = "Select the Correct Answer:"; // Reset label if needed

                // Shuffle options for variety
                const options = [...currentChallengeData.options]; // Create a copy
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]]; // Swap
                }


                options.forEach(optionText => {
                     const button = document.createElement('button');
                     button.classList.add('btn', 'choice-btn');
                     button.textContent = optionText;
                     button.onclick = () => handleMcqSelection(button);
                     multipleChoiceOptions.appendChild(button);
                 });

             } else { // Default to 'explanation' type
                 explanationInputArea.classList.remove('hidden'); // Show textarea
                 multipleChoiceArea.classList.add('hidden'); // Hide MCQ area
                 lastExampleAnswer = currentChallengeData.examplePrompt; // Store example

                  // Show weak prompt section only if weakPrompt has text
                 if(currentChallengeData.weakPrompt && currentChallengeData.weakPrompt.trim() !== '') {
                     weakPromptText.textContent = `"${currentChallengeData.weakPrompt}"`;
                     weakPromptSection.classList.remove('hidden');
                 } else {
                      weakPromptSection.classList.add('hidden');
                 }
             }

             feedbackOutput.innerHTML = '';
             resultTitle.textContent = 'Analyzing...';
             resultTitle.className = 'text-base text-center mb-3';
             lastChallengeSuccess = false;

             showScreen('challenge');
             playSound('next');
        }

         // Handle MCQ button selection
        function handleMcqSelection(button) {
             if (isEvaluating) return; // Don't allow selection during evaluation

             // Deselect previous button if one was selected
             if (selectedMultipleChoiceButton) {
                 selectedMultipleChoiceButton.classList.remove('selected');
             }

             // Select the new button
             button.classList.add('selected');
             selectedMultipleChoiceButton = button;
             submitBtn.disabled = false; // Enable submit once an option is chosen
         }

        function retryChallenge() {
             if (isEvaluating) return;
             playSound('tryAgain');
             showExampleBtn.classList.add('hidden'); // Hide example button

             if (currentChallengeData.type === 'multipleChoice') {
                 // Re-enable MCQ buttons, deselect
                  const buttons = multipleChoiceOptions.querySelectorAll('.choice-btn');
                  buttons.forEach(btn => { btn.disabled = false; btn.classList.remove('selected'); });
                 selectedMultipleChoiceButton = null;
                 submitBtn.disabled = true; // Disable submit until selection
             } else {
                 // Re-enable textarea
                 userPrompt.disabled = false;
                 submitBtn.disabled = userPrompt.value.trim().length === 0; // Re-enable based on content
             }

             showScreen('challenge');
             // Keep userPrompt.value for explanation type
        }

        // Animation Trigger Function (handles score animation)
        async function animateResultsScore(feedbackItems, isPerfect, bonusPoints) {
            const feedbackElements = feedbackOutput.children;
            tryAgainBtn.disabled = true; // Disable buttons during animation
            nextChallengeBtn.disabled = true;
            showExampleBtn.disabled = true;

            // Iterate through feedback items and corresponding DOM elements
            for (let i = 0; i < feedbackItems.length; i++) {
                const item = feedbackItems[i];
                const element = feedbackElements[i];
                if (!element) continue; // Skip if element doesn't exist

                element.classList.add('feedback-highlight'); // Highlight the current item
                await new Promise(resolve => setTimeout(resolve, 150)); // Short pause

                // Animate score ONLY if it's 'good' or 'bonus' and has points
                if ((item.type === 'good' || item.type === 'bonus') && item.points > 0) {
                    await animateScore(item.points); // This updates global score
                    if (item.type === 'bonus' && isPerfect) {
                         playSound('bonus'); // Play bonus sound after its animation
                    }
                } else {
                     await new Promise(resolve => setTimeout(resolve, 300)); // Longer pause if not scoring
                }
                element.classList.remove('feedback-highlight'); // Unhighlight
            }

            updateDisplays(); // Ensure final display matches state

            // Re-enable buttons after animation
            tryAgainBtn.disabled = false;
            nextChallengeBtn.disabled = false;
            // Show example button only if attempt was NOT perfect AND it was an explanation question
            const showExample = !isPerfect && currentChallengeData && currentChallengeData.type === 'explanation';
            showExampleBtn.disabled = !showExample;
            showExampleBtn.classList.toggle('hidden', !showExample);

            isEvaluating = false; // Evaluation complete
        }


        async function evaluatePrompt() {
            if (isEvaluating) return;
            isEvaluating = true;
            lastChallengeSuccess = false;

            playSound('submit');
            if (!currentChallengeData) {
                console.error("Missing challenge data during evaluation."); isEvaluating = false; return;
            }

            let collectedFeedbackItems = [];
            let principlesMet = 0; // Only relevant for explanation type
            let isCorrect = false; // Relevant for MCQ
            let isPerfect = false; // Only relevant for explanation type
            let bonusPoints = 0;
            let pointsScored = 0;

            submitBtn.disabled = true;
            if (currentChallengeData.type === 'multipleChoice') {
                 const buttons = multipleChoiceOptions.querySelectorAll('.choice-btn');
                 buttons.forEach(btn => btn.disabled = true); // Disable MCQ buttons
            } else {
                 userPrompt.disabled = true; // Disable textarea
            }
            showExampleBtn.classList.add('hidden'); // Hide example btn during eval

            // --- Evaluation Logic ---
            if (currentChallengeData.type === 'multipleChoice') {
                if (!selectedMultipleChoiceButton) {
                     console.error("No MCQ option selected."); isEvaluating = false; submitBtn.disabled=false; /* Re-enable? */ return;
                }
                const selectedAnswer = selectedMultipleChoiceButton.textContent;
                const correctAnswer = currentChallengeData.answer;
                isCorrect = (selectedAnswer === correctAnswer);

                if (isCorrect) {
                    pointsScored = 100; // Full points for correct MCQ
                    lastChallengeSuccess = true;
                    collectedFeedbackItems.push({ type: 'good', text: currentChallengeData.feedbackPoints.correct, points: pointsScored });
                } else {
                    pointsScored = 0; // No points for incorrect MCQ
                    lastChallengeSuccess = false;
                    collectedFeedbackItems.push({ type: 'critical', text: currentChallengeData.feedbackPoints.incorrect, points: 0 });
                     // Optionally show the correct answer
                    collectedFeedbackItems.push({ type: 'improve', text: `Correct Answer: ${correctAnswer}`, points: 0 });
                }

            } else { // Explanation Type Evaluation
                const currentAnswerText = userPrompt.value;
                const answerTextLower = currentAnswerText.trim().toLowerCase();
                const feedbackCriteria = currentChallengeData.feedbackPoints;
                const keywords = currentChallengeData.keywords;
                const totalPrinciples = Object.keys(feedbackCriteria).length;

                if (!feedbackCriteria || !keywords) { console.error("Missing feedback/keywords for explanation"); isEvaluating = false; return; }

                const criteriaKeys = Object.keys(feedbackCriteria);
                for (const key of criteriaKeys) {
                    const pointText = feedbackCriteria[key];
                    const keywordRegex = keywords[key];
                    let detected = keywordRegex ? keywordRegex.test(answerTextLower) : false;
                    const principleName = key.charAt(0).toUpperCase() + key.slice(1);
                    let pointsAwarded = 0;
                    let feedbackType = 'improve';
                    let feedbackText = `[-] ${principleName} Missing? ${pointText}`;

                    if (detected) {
                        pointsAwarded = 30; // Points per concept
                        feedbackType = 'good';
                        feedbackText = `[+] ${principleName} Addressed! (+${pointsAwarded} pts)`;
                        principlesMet++;
                    }
                    collectedFeedbackItems.push({ type: feedbackType, text: feedbackText, points: pointsAwarded });
                    pointsScored += pointsAwarded; // Accumulate points
                }

                // Determine success/perfection for explanation
                const successThreshold = Math.ceil(totalPrinciples / 2);
                if (totalPrinciples > 0 && principlesMet === totalPrinciples) {
                    isPerfect = true;
                    bonusPoints = 100;
                    lastChallengeSuccess = true;
                    collectedFeedbackItems.push({ type: 'bonus', text: `[!] PERFECT ANALYSIS! (+${bonusPoints} BONUS!)`, points: bonusPoints });
                } else if (principlesMet >= successThreshold && totalPrinciples > 0) {
                    lastChallengeSuccess = true;
                } else {
                    lastChallengeSuccess = false;
                }
            } // End Explanation Type Evaluation

            // --- Populate Results Screen (Static Content First) ---
            feedbackOutput.innerHTML = collectedFeedbackItems.map(item => `<div class="feedback-item feedback-${item.type}">${item.text}</div>`).join('');
            feedbackOutput.scrollTop = 0; // Scroll to top of feedback

            // --- Set Title, Handle Lives, and Button States ---
            if (isPerfect) { // Only for explanation type
                resultTitle.textContent = 'PERFECT ANALYSIS!';
                resultTitle.className = 'text-base text-center mb-3 flash-perfect';
            } else if (lastChallengeSuccess) { // Correct MCQ or successful explanation
                resultTitle.textContent = 'Analysis Accepted!';
                resultTitle.className = 'text-base text-center mb-3 flash-success';
            } else { // Incorrect MCQ or failed explanation
                resultTitle.textContent = 'Analysis Incomplete!';
                resultTitle.className = 'text-base text-center mb-3 flash-fail';
                lives--;
                playSound('fail');
                updateDisplays();
                if (lives <= 0) { gameOver(); return; }
            }
             // Common settings for results screen
            nextChallengeBtn.textContent = 'Next Question';
             if(lastChallengeSuccess && !isPerfect) playSound('success');


            // --- Show Results and Trigger Animation ---
            showScreen('results');
            tryAgainBtn.onclick = retryChallenge;
            nextChallengeBtn.onclick = () => {
                if (lastChallengeSuccess && currentChallengeIndex !== -1) {
                    if (!completedChallengesByLevel[currentLevel]) completedChallengesByLevel[currentLevel] = [];
                    if (!completedChallengesByLevel[currentLevel].includes(currentChallengeIndex)) {
                        completedChallengesByLevel[currentLevel].push(currentChallengeIndex);
                        console.log(`Ch ${currentChallengeIndex} done in ${currentLevel}. Total:`, completedChallengesByLevel[currentLevel].length);
                    }
                }
                loadChallenge(); // Load next challenge
            };
             // Example button only for explanation type
            showExampleBtn.onclick = openExampleModal;
             const showExample = !isPerfect && currentChallengeData && currentChallengeData.type === 'explanation';
             showExampleBtn.classList.toggle('hidden', !showExample);


            // Disable buttons before starting animation
            tryAgainBtn.disabled = true;
            nextChallengeBtn.disabled = true;
            showExampleBtn.disabled = true; // Re-enabled by animation function if needed

            // Pass points scored in *this attempt* (including bonus if perfect)
            animateResultsScore(collectedFeedbackItems, isPerfect, isPerfect ? bonusPoints : 0);

        } // End evaluatePrompt


        function updateDisplays() {
            livesDisplay.textContent = lives;
            if (!scoreAnimationInterval) { // Update score only if not currently animating
                scoreDisplay.textContent = score;
            }
        }

        function gameOver() {
            playSound('gameOver');
            finalScoreDisplay.textContent = score;
            showScreen('gameOver');
            isEvaluating = false; // Ensure evaluation stops
        }

        function winGame() { // Called when all challenges in a level are done
             playSound('win');
             if (!completedLevels.includes(currentLevel)) {
                 completedLevels.push(currentLevel); // Mark level as fully complete
             }
             populateLevels(); // Update dropdown to show checkmark
             clearedZoneName.textContent = currentLevel; // Display cleared level name
             showScreen('win');
             isEvaluating = false;
         }


        // --- Modal Functions ---
        function openExampleModal() {
            playSound('modalOpen');
            // Clean up citations [cite: X] for display
             let displayAnswer = lastExampleAnswer.replace(/\[cite: \d+(, \d+)*\]/g, '').trim();
            modalAnswerDisplay.textContent = displayAnswer;
            exampleModal.classList.remove('hidden');
        }

        function closeExampleModal() {
             playSound('modalClose');
             exampleModal.classList.add('hidden');
        }


        // --- Event Listeners ---
        levelSelect.addEventListener('change', changeLevel);
        submitBtn.addEventListener('click', evaluatePrompt);
        restartBtn.addEventListener('click', initializeGame);
        playAgainBtn.addEventListener('click', initializeGame);
        // Example modal listeners
        closeModalBtn.addEventListener('click', closeExampleModal);
        closeModalBtnInner.addEventListener('click', closeExampleModal); // Button inside modal also closes
        exampleModal.addEventListener('click', (event) => {
             if (event.target === exampleModal) { closeExampleModal(); } // Close if clicking overlay
         });
        // Input listener for Explanation Textarea
        userPrompt.addEventListener('input', () => {
             // Enable submit only if not evaluating, it's an explanation question, and text exists
            if (!isEvaluating && currentChallengeData && currentChallengeData.type === 'explanation') {
                 submitBtn.disabled = userPrompt.value.trim().length === 0;
             }
             // Submit button for MCQ is enabled via handleMcqSelection
        });

        // --- Initialisation ---
         document.body.addEventListener('click', () => { // Ensure audio context starts
             if (Tone.context.state !== 'running') {
                 Tone.start().catch(e => console.error("Error starting Tone.js:", e));
             }
         }, { once: true });
        document.addEventListener('DOMContentLoaded', initializeGame); // Start game on load

    </script>
</body>
</html>
